{"version":3,"file":"ildhvp4.min.js","sources":["../src/ildhvp4.js"],"sourcesContent":["// Import der Abhängigkeiten\r\nimport $ from 'jquery';\r\nimport Ajax from 'core/ajax';\r\nimport notification from 'core/notification';\r\nimport Str from 'core/str';\r\nimport Url from 'core/url';\r\nimport ModalFactory from 'core/modal_factory';\r\nimport lib from 'format_mooin1pager/lib';\r\nimport Update from 'format_mooin1pager/udateprogressbar';\r\nimport { getCurrentCourseEditor } from 'core_courseformat/courseeditor';\r\n\r\n// ILD Namespace Definition\r\nconst ILD = {};\r\n\r\n// Interactions counter\r\nILD.interactions = [];\r\n\r\n// SingleChoiceInteractions counter\r\nILD.singleChoiceInteractions = [];\r\n\r\n// SubContentIds - avoid duplicated answered statement\r\nILD.subIds = [];\r\n\r\n// Stores QuestionSet PassPercentage\r\nILD.questionSetPassPercentage = [];\r\n\r\n// Stores Essay PassPercentage\r\nILD.EssayPassPercentage = [];\r\n\r\n// Stores Branching scenario info\r\nILD.BranchingScenario = [];\r\n\r\n// Stores maxScore of interactions\r\nILD.maxScore = 0;\r\n\r\n// Stores score of interactions\r\nILD.score = 0;\r\n\r\n// Stores percentage of interactions progress\r\nILD.percentage = 0;\r\n\r\n// Internal H5P function listening for xAPI answered events and stores scores\r\nILD.xAPIAnsweredListener = (event) => {\r\n  console.log(\"xAPI event received:\", event);\r\n  const contentId = event.getVerifiedStatementValue([\r\n    'object',\r\n    'definition',\r\n    'extensions',\r\n    'http://h5p.org/x-api/h5p-local-content-id',\r\n  ]);\r\n  let isInteraction = false;\r\n\r\n  if (event.data.statement.object.objectType === 'Activity') {\r\n    isInteraction = true;\r\n  }\r\n\r\n  if (\r\n    isInteraction &&\r\n    event.getVerb() === 'answered' &&\r\n    typeof ILD.questionSetPassPercentage[contentId] === 'undefined' &&\r\n    typeof ILD.singleChoiceInteractions[contentId] === 'undefined' &&\r\n    typeof ILD.EssayPassPercentage[contentId] === 'undefined' &&\r\n    typeof ILD.BranchingScenario[contentId] === 'undefined'\r\n  ) {\r\n    const score = event.getScore();\r\n    const maxScore = event.getMaxScore();\r\n    let subContentId = event.data.statement.object.id.split('subContentId=')[1];\r\n\r\n    if (ILD.subIds.indexOf(subContentId) !== -1) {\r\n      if (typeof ILD.interactions[contentId] === 'undefined') {\r\n        ILD.interactions[contentId] = 1;\r\n      }\r\n\r\n      const interactions = ILD.interactions[contentId];\r\n      ILD.percentage += (score / maxScore / interactions) * 100;\r\n      ILD.setResult(contentId, ILD.percentage, 100);\r\n    } else if (ILD.subIds.indexOf(subContentId) === -1 && ILD.subIds.length === 0) {\r\n      const percentage = (score / maxScore) * 100;\r\n      ILD.setResult(contentId, percentage, 100);\r\n    }\r\n  }\r\n\r\n  // Handle QuestionSet completion\r\n  if (typeof ILD.questionSetPassPercentage[contentId] !== 'undefined' && event.getVerb() === 'completed') {\r\n    const score = event.getScore();\r\n    const maxScore = event.getMaxScore();\r\n    const percentage = (score / maxScore) * 100;\r\n    const passPercentage = ILD.questionSetPassPercentage[contentId];\r\n\r\n    if (percentage >= passPercentage) {\r\n      ILD.setResult(contentId, 100, 100);\r\n    } else {\r\n      ILD.setResult(contentId, percentage, 100);\r\n    }\r\n  }\r\n\r\n  // Handle Essay score\r\n  if (typeof ILD.EssayPassPercentage[contentId] !== 'undefined' && event.getVerb() === 'scored') {\r\n    const score = event.getScore();\r\n    const maxScore = event.getMaxScore();\r\n    const percentage = (score / maxScore) * 100;\r\n    ILD.setResult(contentId, percentage, 100);\r\n  }\r\n\r\n  // Handle SingleChoiceSet completion\r\n  if (typeof ILD.singleChoiceInteractions[contentId] !== 'undefined' && event.getVerb() === 'completed') {\r\n    const score = event.getScore();\r\n    const maxScore = event.getMaxScore();\r\n    const percentage = (score / maxScore) * 100;\r\n    ILD.setResult(contentId, percentage, 100);\r\n  }\r\n\r\n  // Handle BranchingScenario completion\r\n  if (typeof ILD.BranchingScenario[contentId] !== 'undefined' && event.getVerb() === 'completed') {\r\n    ILD.setResult(contentId, 100, 100);\r\n  }\r\n};\r\n\r\n// Post answered results for user and set progress\r\nILD.setResult = (contentId, score, maxScore) => {\r\n  console.log(\"get score: \", score);\r\n\r\n  const courseId = M.cfg.courseId || document.body.dataset.courseid;\r\n\r\n  Ajax.call([{\r\n    methodname: 'format_mooin1pager_setgrade',\r\n    args: { contentid: contentId, score, maxscore: maxScore }\r\n  }])[0]\r\n    .then(result => {\r\n      console.log(\"AJAX setgrade result:\", result);\r\n\r\n      if (courseId) {\r\n        Update.updateProgressBar(courseId);\r\n      }\r\n\r\n      console.log(`Set result for contentId ${contentId}: ${score}/${maxScore} (${(score / maxScore * 100).toFixed(2)}%)`);\r\n      console.log(\"Debug completion conditions:\");\r\n      console.log(\"- score >= maxScore:\", score >= maxScore);\r\n      console.log(\"- ILD.reactive exists:\", !!ILD.reactive);\r\n      console.log(\"- result.cmid:\", result.cmid);\r\n      console.log(\"- result object:\", result);\r\n      \r\n      // Trigger completion update for course index if H5P activity is completed\r\n      if (score >= maxScore && result.cmid) {\r\n        console.log(`Attempting to trigger completion for H5P cmid: ${result.cmid}`);\r\n        \r\n        // Get reactive instance from the course editor\r\n        try {\r\n          const reactive = getCurrentCourseEditor();\r\n          if (reactive) {\r\n            console.log(`Successfully got reactive instance, triggering completion for cmid: ${result.cmid}`);\r\n            reactive.dispatch('cmCompletion', [result.cmid], true);\r\n          } else {\r\n            console.log(\"Could not get reactive instance from course editor\");\r\n          }\r\n        } catch (error) {\r\n          console.error(\"Error getting reactive instance:\", error);\r\n        }\r\n      }\r\n\r\n    })\r\n    .catch(error => {\r\n      console.error(\"setgrade AJAX error:\", error);\r\n      notification.exception(error);\r\n    });\r\n};\r\n\r\n\r\n\r\n\r\n// Check if library is InteractiveVideo or QuestionSet\r\nILD.checkLibrary = (H5PIntegration, H5PInstance) => {\r\n\r\n  //window.console.log(H5PInstance);\r\n  const contentId = H5PInstance.contentId;\r\n\r\n  //fix\r\n  //progress trigger for hvp videos without interactions or without answerable interactions when video ends\r\n  if (H5PInstance && H5PInstance.video && typeof H5PInstance.video.on === 'function') {\r\n\r\n    // Check if there are no answerable interactions in video\r\n    function noAnswerableInteractions(H5PInstance) {\r\n      return H5PInstance.interactions.every(interaction => !interaction.isAnswerable());\r\n    }\r\n\r\n    //console.log(`H5P Interactive Video instance (${contentId}) detected. Attaching video listener.`);\r\n    if (H5PInstance.interactions\r\n      && Array.isArray(H5PInstance.interactions)\r\n      && H5PInstance.interactions.length === 0\r\n      || noAnswerableInteractions(H5PInstance)) {\r\n\r\n      H5PInstance.video.on('stateChange', function (event) {\r\n        //console.log(`Video stateChange event for contentId ${contentId}:`, event.data);\r\n        // stateChange data === 0 bedeutet Video beendet\r\n        if (event.data === 0) {\r\n          console.log(`✅ Video with contentId ${contentId} finished.`);\r\n          ILD.setResult(contentId, 100, 100);\r\n        }\r\n      });\r\n\r\n\r\n    }\r\n  }\r\n\r\n  if (typeof contentId !== 'undefined') {\r\n    const contentData = H5PIntegration.contents[`cid-${contentId}`];\r\n    const content = JSON.parse(contentData.jsonContent);\r\n    const library = contentData.library;\r\n\r\n\r\n    if (library.includes('H5P.InteractiveVideo')) {\r\n      ILD.getVideoInteractions(contentId, content);\r\n    } else if (library.includes('H5P.QuestionSet')) {\r\n      ILD.getQuestionSetPercentage(contentId, content);\r\n    } else if (library.includes('H5P.SingleChoiceSet')) {\r\n      ILD.getSingleChoiceInteractions(contentId, content);\r\n    } else if (library.includes('H5P.Essay')) {\r\n      ILD.getEssayPercentage(contentId, content);\r\n    } else if (library.includes('H5P.BranchingScenario')) {\r\n      ILD.BranchingScenario[contentId] = 1;\r\n    }\r\n  }\r\n};\r\n\r\n\r\n// Count interactions layers from interactive video element\r\nILD.getVideoInteractions = (contentId, content) => {\r\n  const interactions = content.interactiveVideo.assets.interactions;\r\n  const summaries = content.interactiveVideo.summary.task.params.summaries;\r\n  const notAllowedInteractions = ['H5P.Text', 'H5P.Table', 'H5P.Link', 'H5P.Image', 'H5P.GoToQuestion', 'H5P.Nil', 'H5P.IVHotspot'];\r\n\r\n  let interactionsCounter = 0;\r\n\r\n  if (typeof interactions === 'object') {\r\n    $.each(interactions, (i) => {\r\n      const library = interactions[i].action.library;\r\n      const subid = interactions[i].action.subContentId;\r\n\r\n      if (!notAllowedInteractions.some((item) => library.includes(item))) {\r\n        interactionsCounter++;\r\n        ILD.subIds.push(subid);\r\n      }\r\n    });\r\n\r\n    ILD.interactions[contentId] = interactionsCounter;\r\n  }\r\n\r\n\r\n\r\n  /*\r\n  if (!interactions || (typeof interactions === 'object' && interactionsCounter === 0)) {\r\n    $('.h5p-iframe')[0].contentWindow.onload = () => {\r\n      $('.h5p-iframe')[0].contentWindow.H5P.instances[0].video.on('stateChange', (event) => {\r\n        if (event.data === 0) {\r\n          ILD.setResult(contentId, 100, 100);\r\n        }\r\n      });\r\n    };\r\n  }\r\n    */\r\n\r\n  if (summaries.length) {\r\n    let summary = false;\r\n\r\n    $.each(summaries, (s) => {\r\n      if (typeof summaries[s].summary !== 'undefined') {\r\n        const subId = content.interactiveVideo.summary.task.subContentId;\r\n        ILD.subIds.push(subId);\r\n        summary = true;\r\n      }\r\n    });\r\n\r\n    if (summary) {\r\n      ILD.interactions[contentId] = interactionsCounter + 1;\r\n    }\r\n  }\r\n};\r\n\r\n// Count interactions layers from SingleChoice element\r\nILD.getSingleChoiceInteractions = (contentId, content) => {\r\n  const interactions = content.choices;\r\n\r\n  $.each(interactions, (s) => {\r\n    const subid = interactions[s].subContentId;\r\n    ILD.subIds.push(subid);\r\n  });\r\n\r\n  ILD.singleChoiceInteractions[contentId] = interactions.length;\r\n};\r\n\r\n// Get QuestionSet PassPercentage\r\nILD.getQuestionSetPercentage = (contentId, content) => {\r\n  ILD.questionSetPassPercentage[contentId] = content.passPercentage;\r\n};\r\n\r\n// Get Essay PassPercentage\r\nILD.getEssayPercentage = (contentId, content) => {\r\n  ILD.EssayPassPercentage[contentId] = content.behaviour.percentagePassing;\r\n};\r\n\r\n\r\n\r\n\r\nexport default {\r\n  init(H5PInstance, H5PIntegration, sectionId, reactive) {\r\n    ILD.sectionId = sectionId;\r\n    ILD.reactive = reactive;\r\n    ILD.checkLibrary(H5PIntegration, H5PInstance.instances[0]);\r\n    H5PInstance.externalDispatcher.on('xAPI', ILD.xAPIAnsweredListener);\r\n  },\r\n};\r\n"],"names":["ILD","event","console","log","contentId","getVerifiedStatementValue","isInteraction","data","statement","object","objectType","getVerb","questionSetPassPercentage","singleChoiceInteractions","EssayPassPercentage","BranchingScenario","score","getScore","maxScore","getMaxScore","subContentId","id","split","subIds","indexOf","interactions","percentage","setResult","length","courseId","M","cfg","document","body","dataset","courseid","call","methodname","args","contentid","maxscore","then","result","updateProgressBar","toFixed","reactive","cmid","dispatch","error","catch","exception","H5PIntegration","H5PInstance","video","on","noAnswerableInteractions","every","interaction","isAnswerable","Array","isArray","contentData","contents","content","JSON","parse","jsonContent","library","includes","getVideoInteractions","getQuestionSetPercentage","getSingleChoiceInteractions","getEssayPercentage","interactiveVideo","assets","summaries","summary","task","params","notAllowedInteractions","interactionsCounter","each","i","action","subid","some","item","push","s","subId","choices","passPercentage","behaviour","percentagePassing","init","sectionId","checkLibrary","instances","externalDispatcher","xAPIAnsweredListener"],"mappings":"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"}