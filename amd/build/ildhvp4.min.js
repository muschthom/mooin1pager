define("format_mooin1pager/ildhvp4",["exports","jquery","core/ajax","core/notification","core/str","core/url","core/modal_factory","format_mooin1pager/lib","format_mooin1pager/udateprogressbar","core_courseformat/courseeditor"],(function(_exports,_jquery,_ajax,_notification,_str,_url,_modal_factory,_lib,_udateprogressbar,_courseeditor){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_ajax=_interopRequireDefault(_ajax),_notification=_interopRequireDefault(_notification),_str=_interopRequireDefault(_str),_url=_interopRequireDefault(_url),_modal_factory=_interopRequireDefault(_modal_factory),_lib=_interopRequireDefault(_lib),_udateprogressbar=_interopRequireDefault(_udateprogressbar);const ILD={interactions:[],singleChoiceInteractions:[],subIds:[],questionSetPassPercentage:[],EssayPassPercentage:[],BranchingScenario:[],maxScore:0,score:0,percentage:0,xAPIAnsweredListener:event=>{const contentId=event.getVerifiedStatementValue(["object","definition","extensions","http://h5p.org/x-api/h5p-local-content-id"]);let isInteraction=!1;if("Activity"===event.data.statement.object.objectType&&(isInteraction=!0),isInteraction&&"answered"===event.getVerb()&&void 0===ILD.questionSetPassPercentage[contentId]&&void 0===ILD.singleChoiceInteractions[contentId]&&void 0===ILD.EssayPassPercentage[contentId]&&void 0===ILD.BranchingScenario[contentId]){const score=event.getScore(),maxScore=event.getMaxScore();let subContentId=event.data.statement.object.id.split("subContentId=")[1];if(-1!==ILD.subIds.indexOf(subContentId)){void 0===ILD.interactions[contentId]&&(ILD.interactions[contentId]=1);const interactions=ILD.interactions[contentId];ILD.percentage+=score/maxScore/interactions*100,ILD.setResult(contentId,ILD.percentage,100)}else if(-1===ILD.subIds.indexOf(subContentId)&&0===ILD.subIds.length){const percentage=score/maxScore*100;ILD.setResult(contentId,percentage,100)}}if(void 0!==ILD.questionSetPassPercentage[contentId]&&"completed"===event.getVerb()){const percentage=event.getScore()/event.getMaxScore()*100;percentage>=ILD.questionSetPassPercentage[contentId]?ILD.setResult(contentId,100,100):ILD.setResult(contentId,percentage,100)}if(void 0!==ILD.EssayPassPercentage[contentId]&&"scored"===event.getVerb()){const percentage=event.getScore()/event.getMaxScore()*100;ILD.setResult(contentId,percentage,100)}if(void 0!==ILD.singleChoiceInteractions[contentId]&&"completed"===event.getVerb()){const percentage=event.getScore()/event.getMaxScore()*100;ILD.setResult(contentId,percentage,100)}void 0!==ILD.BranchingScenario[contentId]&&"completed"===event.getVerb()&&ILD.setResult(contentId,100,100)},setResult:(contentId,score,maxScore)=>{console.log("get score: ",score);const courseId=M.cfg.courseId||document.body.dataset.courseid;_ajax.default.call([{methodname:"format_mooin1pager_setgrade",args:{contentid:contentId,score:score,maxscore:maxScore}}])[0].then((result=>{if(console.log("AJAX setgrade result:",result),courseId&&_udateprogressbar.default.updateProgressBar(courseId),score>=maxScore&&result.cmid)try{const reactive=(0,_courseeditor.getCurrentCourseEditor)();reactive?reactive.dispatch("cmCompletion",[result.cmid],!0):console.log("Could not get reactive instance from course editor")}catch(error){console.error("Error getting reactive instance:",error)}})).catch((error=>{console.error("setgrade AJAX error:",error),_notification.default.exception(error)}))},checkLibrary:(H5PIntegration,H5PInstance)=>{const contentId=H5PInstance.contentId;if(H5PInstance&&H5PInstance.video&&"function"==typeof H5PInstance.video.on){function noAnswerableInteractions(H5PInstance){return H5PInstance.interactions.every((interaction=>!interaction.isAnswerable()))}(H5PInstance.interactions&&Array.isArray(H5PInstance.interactions)&&0===H5PInstance.interactions.length||noAnswerableInteractions(H5PInstance))&&H5PInstance.video.on("stateChange",(function(event){0===event.data&&(console.log("âœ… Video with contentId ".concat(contentId," finished.")),ILD.setResult(contentId,100,100))}))}if(void 0!==contentId){const contentData=H5PIntegration.contents["cid-".concat(contentId)],content=JSON.parse(contentData.jsonContent),library=contentData.library;library.includes("H5P.InteractiveVideo")?ILD.getVideoInteractions(contentId,content):library.includes("H5P.QuestionSet")?ILD.getQuestionSetPercentage(contentId,content):library.includes("H5P.SingleChoiceSet")?ILD.getSingleChoiceInteractions(contentId,content):library.includes("H5P.Essay")?ILD.getEssayPercentage(contentId,content):library.includes("H5P.BranchingScenario")&&(ILD.BranchingScenario[contentId]=1)}},getVideoInteractions:(contentId,content)=>{const interactions=content.interactiveVideo.assets.interactions,summaries=content.interactiveVideo.summary.task.params.summaries,notAllowedInteractions=["H5P.Text","H5P.Table","H5P.Link","H5P.Image","H5P.GoToQuestion","H5P.Nil","H5P.IVHotspot"];let interactionsCounter=0;if("object"==typeof interactions&&(_jquery.default.each(interactions,(i=>{const library=interactions[i].action.library,subid=interactions[i].action.subContentId;notAllowedInteractions.some((item=>library.includes(item)))||(interactionsCounter++,ILD.subIds.push(subid))})),ILD.interactions[contentId]=interactionsCounter),summaries.length){let summary=!1;_jquery.default.each(summaries,(s=>{if(void 0!==summaries[s].summary){const subId=content.interactiveVideo.summary.task.subContentId;ILD.subIds.push(subId),summary=!0}})),summary&&(ILD.interactions[contentId]=interactionsCounter+1)}},getSingleChoiceInteractions:(contentId,content)=>{const interactions=content.choices;_jquery.default.each(interactions,(s=>{const subid=interactions[s].subContentId;ILD.subIds.push(subid)})),ILD.singleChoiceInteractions[contentId]=interactions.length},getQuestionSetPercentage:(contentId,content)=>{ILD.questionSetPassPercentage[contentId]=content.passPercentage},getEssayPercentage:(contentId,content)=>{ILD.EssayPassPercentage[contentId]=content.behaviour.percentagePassing}};var _default={init(H5PInstance,H5PIntegration,sectionId,reactive){ILD.sectionId=sectionId,ILD.reactive=reactive,ILD.checkLibrary(H5PIntegration,H5PInstance.instances[0]),H5PInstance.externalDispatcher.on("xAPI",ILD.xAPIAnsweredListener)}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=ildhvp4.min.js.map