{"version":3,"file":"lib.min.js","sources":["../src/lib.js"],"sourcesContent":["define(['jquery', 'core/ajax', 'core/notification', 'format_mooin1pager/ildhvp4', 'format_mooin1pager/udateprogressbar'], function ($, Ajax, Notification, ILD, Update) {\r\n\r\n    function hvpListener() {\r\n        console.log(\"HVP Listener gestartet\");\r\n        const isEditing = document.body.classList.contains('editing') || \r\n                     (typeof M !== 'undefined' && M.cfg && M.cfg.editing);\r\n    \r\n        if (isEditing) {\r\n            console.log(\"editmode\"); \r\n        } else {\r\n            const h5p_contentIds = [];\r\n            const parentIFrames = document.querySelectorAll('iframe');\r\n\r\n            parentIFrames.forEach(parentIFrame => {\r\n                try {\r\n                    const doc = parentIFrame.contentDocument || parentIFrame.contentWindow.document;\r\n                    let nestedIFrame = null;\r\n\r\n                    // Höhe des H5P-iFrames anpassen\r\n                    const adjustParentIFrameHeight = () => {\r\n                        setTimeout(() => {\r\n                            if (nestedIFrame?.contentWindow?.document?.body) {\r\n                                const nestedHeight = nestedIFrame.contentWindow.document.body.scrollHeight;\r\n                                if (nestedHeight > 1) {\r\n                                    parentIFrame.style.height = nestedHeight + \"px\";\r\n                                }\r\n                            }\r\n                        }, 100);\r\n                    };\r\n\r\n                    // Media-Elemente innerhalb des H5P-iFrames beobachten\r\n                    const monitorElementLoads = () => {\r\n                        ['img', 'video', 'iframe', 'embed', 'object'].forEach(tag => {\r\n                            Array.from(nestedIFrame.contentDocument.getElementsByTagName(tag))\r\n                                .forEach(el => {\r\n                                    el.addEventListener('load', adjustParentIFrameHeight);\r\n                                    el.addEventListener('resize', adjustParentIFrameHeight);\r\n                                });\r\n                        });\r\n                    };\r\n\r\n                    // Prüft, ob H5P geladen ist und registriert Listener\r\n                    const checkForH5P = () => {\r\n                        nestedIFrame = nestedIFrame || doc.querySelector('.h5p-iframe');\r\n                        if (nestedIFrame?.contentWindow) {\r\n                            const pw = nestedIFrame.contentWindow;\r\n                            if (pw.H5P && pw.H5P.externalDispatcher) {\r\n                                const contentId = pw.H5P.instances[0]?.contentId;\r\n                                if (!h5p_contentIds.includes(contentId)) {\r\n                                    h5p_contentIds.push(contentId);\r\n                                    // Optionale Initialisierung: ILD.init(...)\r\n                                    var H5PIntegration = nestedIFrame.contentWindow.H5PIntegration;\r\n                                    var H5P = nestedIFrame.contentWindow.H5P;\r\n                                    ILD.init(H5P, H5PIntegration, this.id, this.reactive);\r\n                                }\r\n\r\n                                // H5P Interaction abfangen\r\n                                pw.H5P.externalDispatcher.on('xAPI', event => {\r\n                                    //console.log(\"H5P xAPI Event:\", event);\r\n                                    const courseId = M.cfg.courseId || document.body.dataset.courseid;\r\n                                    Update.updateProgressBar(courseId);\r\n                                });\r\n\r\n                                adjustParentIFrameHeight();\r\n                                monitorElementLoads();\r\n\r\n                                // MutationObserver, um auftretende Änderungen im H5P-Content zu erkennen\r\n                                const observer = new MutationObserver(muts => {\r\n                                    muts.forEach(mut => {\r\n                                        if (mut.addedNodes.length || mut.attributeName === 'src') {\r\n                                            adjustParentIFrameHeight();\r\n                                        }\r\n                                    });\r\n                                });\r\n                                observer.observe(nestedIFrame.contentDocument, {\r\n                                    childList: true,\r\n                                    subtree: true,\r\n                                    attributes: true\r\n                                });\r\n                                return true;\r\n                            }\r\n                        }\r\n                        return false;\r\n                    };\r\n\r\n                    // Prüft existierende H5P-iFrames\r\n                    const initOnce = () => {\r\n                        if (!checkForH5P()) {\r\n                            const outerObserver = new MutationObserver(muts => {\r\n                                muts.forEach(mut => {\r\n                                    if (mut.addedNodes.length && checkForH5P()) {\r\n                                        outerObserver.disconnect();\r\n                                    }\r\n                                });\r\n                            });\r\n                            outerObserver.observe(doc.body, { childList: true, subtree: true });\r\n                        }\r\n                    };\r\n\r\n                    initOnce();\r\n                } catch (err) {\r\n                    console.error(\"Fehler in HVP Listener:\", err);\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n\r\n    return {\r\n        hvpListener: hvpListener\r\n    };\r\n});"],"names":["define","$","Ajax","Notification","ILD","Update","hvpListener","console","log","document","body","classList","contains","M","cfg","editing","h5p_contentIds","querySelectorAll","forEach","parentIFrame","doc","contentDocument","contentWindow","nestedIFrame","adjustParentIFrameHeight","setTimeout","_nestedIFrame","_nestedIFrame$content","_nestedIFrame$content2","nestedHeight","scrollHeight","style","height","monitorElementLoads","tag","Array","from","getElementsByTagName","el","addEventListener","checkForH5P","querySelector","_nestedIFrame2","pw","H5P","externalDispatcher","contentId","instances","_pw$H5P$instances$","includes","push","H5PIntegration","init","this","id","reactive","on","event","courseId","dataset","courseid","updateProgressBar","MutationObserver","muts","mut","addedNodes","length","attributeName","observe","childList","subtree","attributes","outerObserver","disconnect","initOnce","err","error"],"mappings":"AAAAA,gCAAO,CAAC,SAAU,YAAa,oBAAqB,6BAA8B,wCAAwC,SAAUC,EAAGC,KAAMC,aAAcC,IAAKC,cA4GrJ,CACHC,0BA1GAC,QAAQC,IAAI,0BACMC,SAASC,KAAKC,UAAUC,SAAS,YACxB,oBAANC,GAAqBA,EAAEC,KAAOD,EAAEC,IAAIC,QAGrDR,QAAQC,IAAI,gBACT,OACGQ,eAAiB,GACDP,SAASQ,iBAAiB,UAElCC,SAAQC,yBAERC,IAAMD,aAAaE,iBAAmBF,aAAaG,cAAcb,aACnEc,aAAe,WAGbC,yBAA2B,KAC7BC,YAAW,6FACHF,qEAAAG,cAAcJ,+EAAdK,sBAA6BlB,4CAA7BmB,uBAAuClB,KAAM,OACvCmB,aAAeN,aAAaD,cAAcb,SAASC,KAAKoB,aAC1DD,aAAe,IACfV,aAAaY,MAAMC,OAASH,aAAe,SAGpD,MAIDI,oBAAsB,MACvB,MAAO,QAAS,SAAU,QAAS,UAAUf,SAAQgB,MAClDC,MAAMC,KAAKb,aAAaF,gBAAgBgB,qBAAqBH,MACxDhB,SAAQoB,KACLA,GAAGC,iBAAiB,OAAQf,0BAC5Bc,GAAGC,iBAAiB,SAAUf,iCAMxCgB,YAAc,2BAChBjB,aAAeA,cAAgBH,IAAIqB,cAAc,sCAC7ClB,wCAAAmB,eAAcpB,cAAe,OACvBqB,GAAKpB,aAAaD,iBACpBqB,GAAGC,KAAOD,GAAGC,IAAIC,mBAAoB,8BAC/BC,qCAAYH,GAAGC,IAAIG,UAAU,wCAAjBC,mBAAqBF,cAClC9B,eAAeiC,SAASH,WAAY,CACrC9B,eAAekC,KAAKJ,eAEhBK,eAAiB5B,aAAaD,cAAc6B,eAC5CP,IAAMrB,aAAaD,cAAcsB,IACrCxC,IAAIgD,KAAKR,IAAKO,eAAgBE,KAAKC,GAAID,KAAKE,UAIhDZ,GAAGC,IAAIC,mBAAmBW,GAAG,QAAQC,cAE3BC,SAAW7C,EAAEC,IAAI4C,UAAYjD,SAASC,KAAKiD,QAAQC,SACzDvD,OAAOwD,kBAAkBH,aAG7BlC,2BACAS,6BAGiB,IAAI6B,kBAAiBC,OAClCA,KAAK7C,SAAQ8C,OACLA,IAAIC,WAAWC,QAAgC,QAAtBF,IAAIG,gBAC7B3C,iCAIH4C,QAAQ7C,aAAaF,gBAAiB,CAC3CgD,WAAW,EACXC,SAAS,EACTC,YAAY,KAET,UAGR,GAIM,UACR/B,cAAe,OACVgC,cAAgB,IAAIV,kBAAiBC,OACvCA,KAAK7C,SAAQ8C,MACLA,IAAIC,WAAWC,QAAU1B,eACzBgC,cAAcC,mBAI1BD,cAAcJ,QAAQhD,IAAIV,KAAM,CAAE2D,WAAW,EAAMC,SAAS,MAIpEI,GACF,MAAOC,KACLpE,QAAQqE,MAAM,0BAA2BD"}